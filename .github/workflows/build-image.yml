name: Build and Release Disk Image

on:
  push:
    branches:
      - main
      - develop
    tags:
      - 'v*'
  pull_request:
    branches:
      - main
      - develop
  workflow_dispatch:

jobs:
  build-image:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build disk image using Docker
        run: |
          echo "Building SparkOS disk image..."
          # Build the image builder container
          docker buildx build \
            --file Dockerfile.image \
            --target image-builder \
            --tag sparkos:image-builder \
            --load \
            .
          
          # Create a container and extract the image
          echo "Extracting disk image..."
          CONTAINER_ID=$(docker create sparkos:image-builder)
          docker cp "$CONTAINER_ID:/output/sparkos.img.gz" ./sparkos.img.gz
          docker rm "$CONTAINER_ID"
          
          echo "Disk image created successfully!"
          ls -lh sparkos.img.gz

      - name: Verify disk image
        run: |
          echo "Verifying UEFI-bootable disk image..."
          if [ ! -f sparkos.img.gz ]; then
            echo "ERROR: Disk image not found!"
            exit 1
          fi
          
          # Show file info
          ls -lh sparkos.img.gz
          file sparkos.img.gz
          
          # Decompress and check
          echo "Decompressing to verify..."
          gunzip -c sparkos.img.gz > sparkos.img
          ls -lh sparkos.img
          file sparkos.img
          
          # Show partition table (should be GPT)
          echo ""
          echo "=== Partition Table (GPT) ==="
          sudo fdisk -l sparkos.img || true
          sudo parted sparkos.img print || true
          
          # Try to mount and inspect partitions
          echo ""
          echo "=== Inspecting Partitions ==="
          mkdir -p /tmp/sparkos_esp /tmp/sparkos_root
          
          # Set up loop device
          LOOP_DEV=$(sudo losetup -fP --show sparkos.img)
          echo "Loop device: $LOOP_DEV"
          ls -la ${LOOP_DEV}*
          
          # Mount and check ESP
          if sudo mount -o ro ${LOOP_DEV}p1 /tmp/sparkos_esp 2>/dev/null; then
            echo "âœ“ EFI System Partition mounted"
            echo "ESP contents:"
            ls -laR /tmp/sparkos_esp/
            if [ -f /tmp/sparkos_esp/EFI/BOOT/BOOTX64.EFI ]; then
              echo "âœ“ UEFI bootloader (GRUB) found"
            fi
            if [ -f /tmp/sparkos_esp/boot/vmlinuz ]; then
              echo "âœ“ Kernel found"
            fi
            sudo umount /tmp/sparkos_esp
          fi
          
          # Mount and check root partition
          if sudo mount -o ro ${LOOP_DEV}p2 /tmp/sparkos_root 2>/dev/null; then
            echo "âœ“ Root partition mounted"
            echo "Root contents:"
            ls -la /tmp/sparkos_root/
            if [ -f /tmp/sparkos_root/sbin/init ]; then
              echo "âœ“ Init binary found"
              ls -lh /tmp/sparkos_root/sbin/init
            fi
            if [ -f /tmp/sparkos_root/bin/busybox ]; then
              echo "âœ“ Busybox found"
            fi
            sudo umount /tmp/sparkos_root
          fi
          
          # Cleanup
          sudo losetup -d $LOOP_DEV
          
          echo ""
          echo "=== Verification Complete ==="
          echo "âœ“ UEFI-bootable image with GPT partition table"
          echo "âœ“ EFI System Partition with GRUB"
          echo "âœ“ Root partition with init system and busybox"

      - name: Create release package
        run: |
          echo "Creating release package..."
          mkdir -p release
          
          # Move the compressed image
          mv sparkos.img.gz release/
          
          # Create a README for the release
          cat > release/README.txt << 'EOF'
          SparkOS UEFI-Bootable Disk Image
          ==================================
          
          This package contains a UEFI-bootable disk image with SparkOS.
          
          Files:
          - sparkos.img.gz - Compressed UEFI-bootable disk image (~1GB)
          
          What's Included:
          ---------------
          âœ“ GPT partition table
          âœ“ EFI System Partition (ESP) with FAT32 filesystem
          âœ“ GRUB UEFI bootloader
          âœ“ Linux kernel
          âœ“ SparkOS init system
          âœ“ Busybox utilities
          âœ“ Basic FHS-compliant filesystem structure
          
          Boot Support:
          ------------
          âœ“ UEFI boot (x86_64 systems)
          âœ“ Automatic boot after 3 seconds
          âœ“ Console on tty1
          
          Quick Start:
          -----------
          
          1. Decompress the image:
             gunzip sparkos.img.gz
          
          2. Write to USB drive (Linux - BE CAREFUL!):
             sudo dd if=sparkos.img of=/dev/sdX bs=4M status=progress oflag=sync
             
             WARNING: Replace /dev/sdX with your actual USB drive device.
                      This will DESTROY all data on the target drive!
          
          3. Boot from USB:
             - Insert the USB drive into a UEFI-capable system
             - Enter BIOS/UEFI settings (usually F2, F12, DEL, or ESC at boot)
             - Select the USB drive as boot device
             - SparkOS should boot automatically
          
          Advanced - Inspect Partitions:
          ------------------------------
          
          To mount and inspect the partitions:
          
          # Set up loop device
          sudo losetup -fP --show sparkos.img
          # Note the loop device name (e.g., /dev/loop0)
          
          # Mount ESP (EFI System Partition)
          sudo mount /dev/loop0p1 /mnt
          ls -la /mnt/EFI
          sudo umount /mnt
          
          # Mount root partition
          sudo mount /dev/loop0p2 /mnt
          ls -la /mnt
          sudo umount /mnt
          
          # Cleanup
          sudo losetup -d /dev/loop0
          
          Documentation:
          -------------
          See the full documentation at:
          https://github.com/johndoe6345789/SparkOS
          
          Support:
          -------
          For issues and questions, visit:
          https://github.com/johndoe6345789/SparkOS/issues
          EOF
          
          # Create a ZIP with the image and README
          cd release || exit 1
          zip sparkos-image.zip sparkos.img.gz README.txt
          cd .. || exit 1
          
          echo "Release package created!"
          ls -lh release/

      - name: Upload image artifact
        uses: actions/upload-artifact@v4
        with:
          name: sparkos-image-${{ github.sha }}
          path: |
            release/sparkos-image.zip
            release/sparkos.img.gz
          retention-days: 90

      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: |
            release/sparkos-image.zip
            release/sparkos.img.gz
          body: |
            # SparkOS UEFI-Bootable Disk Image Release ${{ github.ref_name }}
            
            This release includes a **UEFI-bootable** disk image with SparkOS.
            
            ## What's Included
            
            - **sparkos-image.zip**: Complete package with image and README
            - **sparkos.img.gz**: Compressed UEFI-bootable disk image (~1GB)
            
            ## Features
            
            âœ… **UEFI Boot Support** - Boot on modern UEFI systems  
            âœ… **GPT Partition Table** - Modern partitioning scheme  
            âœ… **GRUB Bootloader** - Reliable UEFI bootloader  
            âœ… **Linux Kernel** - Full kernel included  
            âœ… **SparkOS Init System** - Custom init with busybox  
            âœ… **Ready to Boot** - Write to USB and boot immediately  
            
            ## Quick Start
            
            ### Write to USB and Boot
            
            ```bash
            # Download and decompress
            wget https://github.com/johndoe6345789/SparkOS/releases/download/${{ github.ref_name }}/sparkos.img.gz
            gunzip sparkos.img.gz
            
            # Write to USB drive (Linux - BE CAREFUL!)
            sudo dd if=sparkos.img of=/dev/sdX bs=4M status=progress oflag=sync
            ```
            
            **âš ï¸ WARNING**: Replace `/dev/sdX` with your actual USB device (e.g., `/dev/sdb`). This will **ERASE ALL DATA** on the target drive!
            
            ### Boot Instructions
            
            1. Insert the USB drive into a UEFI-capable system
            2. Enter BIOS/UEFI settings (usually F2, F12, DEL, or ESC at boot)
            3. Select the USB drive as boot device
            4. SparkOS will boot automatically after 3 seconds
            
            ### Inspect Partitions (Advanced)
            
            ```bash
            # Set up loop device
            LOOP_DEV=$(sudo losetup -fP --show sparkos.img)
            
            # Mount ESP (EFI System Partition)
            sudo mount ${LOOP_DEV}p1 /mnt
            ls -la /mnt/EFI  # View bootloader and kernel
            sudo umount /mnt
            
            # Mount root partition
            sudo mount ${LOOP_DEV}p2 /mnt
            ls -la /mnt      # View SparkOS filesystem
            sudo umount /mnt
            
            # Cleanup
            sudo losetup -d $LOOP_DEV
            ```
            
            ## Technical Details
            
            - **Size**: ~1GB (compressed)
            - **Partition Table**: GPT
            - **ESP**: 200MB FAT32 (EFI System Partition)
            - **Root**: ~800MB ext4
            - **Bootloader**: GRUB (UEFI)
            - **Kernel**: Linux kernel (from Ubuntu)
            - **Init**: SparkOS custom init system
            - **Shell**: Busybox
            
            ## Docker Image
            
            A Docker image is also available:
            ```bash
            docker pull ghcr.io/johndoe6345789/sparkos:${{ github.ref_name }}
            ```
            
            ## Documentation
            
            See [README.md](https://github.com/johndoe6345789/SparkOS/blob/main/README.md) for full documentation.
            
            ## What's Changed
            
            See commit history for detailed changes.
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Output summary
        run: |
          echo "### Disk Image Build Summary ðŸ’¾" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** âœ… Success" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Disk Image:**" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          ls -lh release/sparkos.img.gz >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Release Package:**" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          ls -lh release/sparkos-image.zip >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            echo "**Release:** Created GitHub release for ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Download from: https://github.com/${{ github.repository }}/releases/tag/${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Artifact:** Uploaded as workflow artifact (available for 90 days)" >> $GITHUB_STEP_SUMMARY
          fi
